<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>완벽한 3 D 자동차 게임</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#111;color:#fff;font-family:Arial,Helvetica,sans-serif}
.noSel{user-select:none;-webkit-user-select:none;-moz-user-select:none}
#rotWarn{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:24px 36px;background:rgba(0,0,0,.8);border-radius:14px;z-index:999;font:700 1.2rem/1 sans-serif;display:none}
#hud,#gear{position:fixed;padding:10px 16px;border-radius:10px;background:rgba(0,0,0,.65);font:700 16px/1.3 sans-serif;z-index:50}
#hud{top:16px;left:16px} #gear{top:16px;right:16px}
.pad{position:fixed;bottom:22px;display:flex;gap:14px;z-index:50}
#leftPad{left:22px} #rightPad{right:22px;flex-direction:column}
.btn{padding:16px 22px;border:none;border-radius:12px;background:#0078d7;font:700 16px sans-serif;color:#fff;box-shadow:0 3px 6px rgba(0,0,0,.4)}
.btn:active{background:#055aa4}
.gearBtn{position:fixed;top:68px;padding:10px 16px;border:none;border-radius:12px;background:#0078d7;color:#fff;font:700 16px sans-serif;z-index:50}
.act{background:#055aa4!important}
@media(max-width:640px){.btn{padding:20px 26px;font-size:18px}}
</style>
</head>
<body class="noSel">
<div id="rotWarn">가로 모드로 전환하세요</div>
<div id="hud">속도 0 km/h</div>
<div id="gear">기어 P</div>

<!-- 조작 버튼 -->
<div id="leftPad"  class="pad"><button id="bLeft"  class="btn">◀</button><button id="bRight" class="btn">▶</button></div>
<div id="rightPad" class="pad"><button id="bAccel" class="btn">▲</button><button id="bBrake" class="btn">▼</button></div>

<!-- 기어 버튼 4개 -->
<button data-g="P" style="right:20px"  class="gearBtn act">P</button>
<button data-g="R" style="right:80px"  class="gearBtn">R</button>
<button data-g="N" style="right:140px" class="gearBtn">N</button>
<button data-g="D" style="right:200px" class="gearBtn">D</button>

<script type="module">
import * as THREE  from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

/* === 회전 경고 === */
const rotWarn=document.getElementById('rotWarn');
function chkOri(){rotWarn.style.display=innerHeight>innerWidth?'block':'none'}
addEventListener('resize',chkOri);addEventListener('orientationchange',chkOri);chkOri();

/* === THREE.js === */
const scene=new THREE.Scene();scene.background=new THREE.Color(0x1b1b1b);
const cam=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,2e3);cam.position.set(0,5,-12);
const ren=new THREE.WebGLRenderer({antialias:true});ren.setSize(innerWidth,innerHeight);document.body.appendChild(ren.domElement);
addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();ren.setSize(innerWidth,innerHeight)});

/* 조명 */
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,.75));
const dLight=new THREE.DirectionalLight(0xffffff,.9);dLight.position.set(8,18,8);scene.add(dLight);

/* === Cannon 월드 === */
const world=new CANNON.World({gravity:new CANNON.Vec3(0,-9.82,0)});
world.broadphase=new CANNON.SAPBroadphase(world);
world.defaultContactMaterial.friction=.6;

/* 바닥(heightfield 트랙) */
(function(){
  const w=120,l=600,segW=17,segL=121,mat=[];
  for(let x=0;x<segW;x++){const row=[];for(let z=0;z<segL;z++){
    const h=Math.sin(z/segL*Math.PI*4)*1.5+Math.cos(x/segW*Math.PI*2)*.6;row.push(h);}
  mat.push(row);}
  const hf=new CANNON.Heightfield(mat,{elementSize:l/(segL-1)});
  const hfBody=new CANNON.Body({mass:0});hfBody.addShape(hf,new CANNON.Vec3(-w/2,0,-l/2));world.addBody(hfBody);

  const g=new THREE.PlaneGeometry(w,l,segW-1,segL-1);
  const pos=g.attributes.position;
  for(let i=0;i<pos.count;i++){
    const xi=i%segW,zi=Math.floor(i/segW);pos.setY(i,mat[xi][zi]);
  }g.computeVertexNormals();g.rotateX(-Math.PI/2);
  scene.add(new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:0x2a2a2a})));
})();

/* === 차량 === */
function roundedCar(w,h,d,r,seg=10,col=0xff5028){
  const grp=new THREE.Group(),mat=new THREE.MeshStandardMaterial({color:col,metalness:.6,roughness:.3});
  grp.add(new THREE.Mesh(new THREE.BoxGeometry(w-2*r,h,d-2*r),mat).position.set(0,h/2,0));
  const sph=new THREE.SphereGeometry(r,seg*2,seg);
  [[1,1],[-1,1],[1,-1],[-1,-1]].forEach(([sx,sz])=>{
    const a=new THREE.Mesh(sph,mat);a.position.set(sx*(w/2-r),r,sz*(d/2-r));grp.add(a);
    const b=a.clone();b.position.y=h-r;grp.add(b);});
  return grp;
}
const carMesh=roundedCar(3.2,1.2,6.2,.35,12,0xff392e);scene.add(carMesh);
const chassis=new CANNON.Body({mass:160});
chassis.addShape(new CANNON.Box(new CANNON.Vec3(1.6,.6,3.1)));
chassis.position.set(0,3,0);world.addBody(chassis);

const vehicle=new CANNON.RaycastVehicle({chassisBody:chassis,indexForwardAxis:2,indexRightAxis:0,indexUpAxis:1});
const wRad=.55,opt={radius:wRad,directionLocal:new CANNON.Vec3(0,-1,0),
 axleLocal:new CANNON.Vec3(-1,0,0),suspensionStiffness:34,suspensionRestLength:.32,frictionSlip:5,
 dampingRelaxation:2.3,dampingCompression:4.4,rollInfluence:.01,maxSuspensionTravel:.3,
 useCustomSlidingRotationalSpeed:true,customSlidingRotationalSpeed:-30};
[[ -1.2,0, 2.5],[1.2,0,2.5],[ -1.2,0,-2.5],[1.2,0,-2.5]].forEach((p,i)=>
  vehicle.addWheel({...opt,isFrontWheel:i<2,chassisConnectionPointLocal:new CANNON.Vec3(...p)}));
vehicle.addToWorld(world);

const wGeo=new THREE.CylinderGeometry(wRad,wRad,.45,28);
const wMat=new THREE.MeshStandardMaterial({color:0x131313,metalness:.8,roughness:.55});
const wheelMeshes=vehicle.wheelInfos.map(()=>{const m=new THREE.Mesh(wGeo,wMat);m.rotation.z=Math.PI/2;scene.add(m);return m;});

/* AI 차량 */
const aiMesh=roundedCar(3.2,1.2,6.2,.3,10,0x1e88e5);scene.add(aiMesh);
const aiBody=new CANNON.Body({mass:0});aiBody.addShape(new CANNON.Box(new CANNON.Vec3(1.6,.6,3.1)));
aiBody.position.set(1.5,3,-120);world.addBody(aiBody);
let aiSpd=18;function updAI(dt){aiBody.position.z+=aiSpd*0.2778*dt;aiMesh.position.copy(aiBody.position);}

/* === 입력 & UI === */
const k={left:false,right:false,accel:false,brake:false};
const bind=(id,prop)=>{const b=document.getElementById(id);
 ['pointerdown','touchstart'].forEach(e=>b.addEventListener(e,ev=>{ev.preventDefault();k[prop]=true}));
 ['pointerup','pointerleave','touchend'].forEach(e=>b.addEventListener(e,()=>k[prop]=false));};
bind('bLeft','left');bind('bRight','right');bind('bAccel','accel');bind('bBrake','brake');

const gearBtns=[...document.querySelectorAll('.gearBtn')];
let gear='P';function setGear(g){gear=g;document.getElementById('gear').textContent='기어 '+g;
 gearBtns.forEach(b=>b.classList.toggle('act',b.dataset.g===g));
 if(g==='P')vehicle.wheelInfos.forEach((_,i)=>vehicle.setBrake(2e5,i));
 else        vehicle.wheelInfos.forEach((_,i)=>vehicle.setBrake(0,i));}
gearBtns.forEach(b=>b.onclick=()=>setGear(b.dataset.g));

/* 오디오 */
const engS=new Audio('https://cdn.jsdelivr.net/gh/napkyn/media-resources@main/engine_loop.mp3');
engS.loop=true;engS.volume=.25;engS.play().catch(()=>{});
const skidS=new Audio('https://cdn.jsdelivr.net/gh/napkyn/media-resources@main/skid_loop.mp3');
skidS.loop=true;skidS.volume=0; skidS.play().catch(()=>{});

/* === 루프 === */
const hud=document.getElementById('hud');
let steer=0,maxSteer=Math.PI/6,lastT=performance.now();

function step(){
 requestAnimationFrame(step);
 const now=performance.now(),dt=(now-lastT)/1000;lastT=now;

 /* 조향 */
 if(k.left)  steer=Math.min(steer+.05,maxSteer);
 else if(k.right) steer=Math.max(steer-.05,-maxSteer);
 else steer*=.9;
 vehicle.setSteeringValue(steer,0);vehicle.setSteeringValue(steer,1);

 /* 기어별 힘 */
 const fwd=3500,rev=1600,brkMax=1200;
 let eng=0,brk=k.brake?brkMax:0;
 if(gear==='D') eng=k.accel?fwd:0;
 if(gear==='R') eng=k.accel?-rev:0;
 if(gear==='N') eng=0;
 if(gear==='P'){eng=0;brk=3e5;}
 vehicle.applyEngineForce(eng,2);vehicle.applyEngineForce(eng,3);
 [0,1,2,3].forEach(i=>vehicle.setBrake(brk,i));

 /* 물리 스텝 */
 world.step(1/60,dt,8);

 /* THREE 동기화 */
 carMesh.position.copy(chassis.position);carMesh.quaternion.copy(chassis.quaternion);
 vehicle.wheelInfos.forEach((wh,i)=>{vehicle.updateWheelTransform(i);
   wheelMeshes[i].position.copy(wh.worldTransform.position);
   wheelMeshes[i].quaternion.copy(wh.worldTransform.quaternion);});
 updAI(dt);

 /* 카메라 */
 const off=new THREE.Vector3(0,4,10).applyQuaternion(carMesh.quaternion);
 cam.position.lerp(carMesh.position.clone().add(off),.08);cam.lookAt(carMesh.position);

 /* HUD & 사운드 */
 const spd=chassis.velocity.length()*3.6;
 hud.textContent=`속도 ${spd.toFixed(0)} km/h`;
 engS.playbackRate=1+Math.min(spd/120,1);
 skidS.volume= k.brake&&spd>12 ? .4 : 0;

 ren.render(scene,cam);
}
setGear('P');step();
</script>
</body>
</html>
