<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>완벽한 3D 자동차 게임</title>
  <style>
    /* UI와 스타일 생략된 부분 없이 완전 구성 */
    body { margin: 0; overflow: hidden; background: #111; color: white; font-family: sans-serif; }
    #rotateWarning { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); padding: 20px 40px; border-radius: 12px; z-index: 1000; font-size: 1.2rem; display: none; }
    #hud, #gearDisplay { position: fixed; padding: 10px 15px; background: rgba(0,0,0,0.6); border-radius: 10px; z-index: 100; font-weight: bold; font-size: 16px; user-select: none; }
    #hud { top: 15px; left: 15px; }
    #gearDisplay { top: 15px; right: 15px; }
    #controlsLeft, #controlsRight { position: fixed; bottom: 20px; display: flex; gap: 12px; z-index: 100; }
    #controlsLeft { left: 20px; }
    #controlsRight { right: 20px; flex-direction: column; }
    button.controlBtn { padding: 14px 20px; border: none; border-radius: 10px; background: #0078d7; color: white; font-weight: bold; font-size: 16px; }
    button.controlBtn:active { background: #005a9e; }
  </style>
</head>
<body>
  <div id="rotateWarning">가로 모드로 전환해주세요</div>
  <div id="hud">속도: 0 km/h</div>
  <div id="gearDisplay">기어: P</div>
  <div id="controlsLeft">
    <button id="btnLeft" class="controlBtn">◀ 좌</button>
    <button id="btnRight" class="controlBtn">우 ▶</button>
  </div>
  <div id="controlsRight">
    <button id="btnAccel" class="controlBtn">엑셀</button>
    <button id="btnBrake" class="controlBtn">브레이크</button>
    <button id="btnGear" class="controlBtn">기어 변경</button>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
    import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

    // 회전 경고
    const rotateWarning = document.getElementById('rotateWarning');
    function checkOrientation() {
      rotateWarning.style.display = (window.innerHeight > window.innerWidth) ? 'block' : 'none';
    }
    window.addEventListener('resize', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    checkOrientation();

    // UI 요소
    const hud = document.getElementById("hud");
    const gearDisplay = document.getElementById("gearDisplay");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");
    const btnAccel = document.getElementById("btnAccel");
    const btnBrake = document.getElementById("btnBrake");
    const btnGear = document.getElementById("btnGear");

    // 기본 THREE.js 설정
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, -12);

    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // CANNON-es 설정
    const world = new CANNON.World({
      gravity: new CANNON.Vec3(0, -9.82, 0),
    });
    world.broadphase = new CANNON.SAPBroadphase(world);
    world.defaultContactMaterial.friction = 0.6;

    // 바닥
    const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x444444 });
    const groundMesh = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), groundMaterial);
    groundMesh.rotation.x = -Math.PI / 2;
    scene.add(groundMesh);

    const groundShape = new CANNON.Plane();
    const groundBody = new CANNON.Body({ mass: 0 });
    groundBody.addShape(groundShape);
    groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    world.addBody(groundBody);

    /* ───────────────────────────────────────────────
   [파트 2] – 차량, 바퀴, 트랙(커브·언덕), AI 차량
─────────────────────────────────────────────── */

// 1) 곡선형 차체(라운드 박스) 생성 함수 --------------
function createRoundedCarMesh(w,h,d,r,segments=8){
  const g = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0xff5028,metalness:0.6,roughness:0.3});

  // 중앙 박스
  g.add(new THREE.Mesh(
    new THREE.BoxGeometry(w-2*r, h, d-2*r), mat).translateY(h/2));

  // 4×2 코너 구
  const sph = new THREE.SphereGeometry(r, segments*2, segments);
  [[1,1],[ -1,1],[1,-1],[-1,-1]].forEach(([sx,sz])=>{
    const a=new THREE.Mesh(sph,mat);
    a.position.set(sx*(w/2-r), r       , sz*(d/2-r)); g.add(a);
    const b=a.clone(); b.position.y=h-r;               g.add(b);
  });

  // 엣지 실린더(12개) – 생략 가능 (시각적 완성도 ↑)
  return g;
}

// 2) 플레이어 차량(차체 + 물리 바디) ------------------
const carMesh = createRoundedCarMesh(3.2,1.2,6.2,0.35,10);
scene.add(carMesh);

const chassisShape = new CANNON.Box(new CANNON.Vec3(1.6,0.6,3.1));
const chassisBody  = new CANNON.Body({mass:160});
chassisBody.addShape(chassisShape);
chassisBody.position.set(0,2,0);
world.addBody(chassisBody);

// 3) RaycastVehicle + 바퀴 ---------------------------
const vehicle = new CANNON.RaycastVehicle({
  chassisBody,
  indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2
});
const wheelRad=.55, wheelOpts={
  radius:wheelRad,
  directionLocal:new CANNON.Vec3(0,-1,0),
  axleLocal:new CANNON.Vec3(-1,0,0),
  suspensionStiffness:35,suspensionRestLength:.32,
  frictionSlip:5,rollInfluence:.01,
  maxSuspensionTravel:.3,useCustomSlidingRotationalSpeed:true,customSlidingRotationalSpeed:-30
};
const wheelPos=[[ -1.2,0, 2.4],[1.2,0,2.4],[ -1.2,0,-2.4],[1.2,0,-2.4]];
wheelPos.forEach((p,i)=>vehicle.addWheel({...wheelOpts,
  chassisConnectionPointLocal:new CANNON.Vec3(...p),isFrontWheel:i<2}));
vehicle.addToWorld(world);

// THREE 바퀴 메쉬
const wheelGeo=new THREE.CylinderGeometry(wheelRad,wheelRad,0.45,32);
const wheelMat=new THREE.MeshStandardMaterial({color:0x111111,metalness:.8,roughness:.5});
const wheelMeshes=wheelPos.map(p=>{
  const m=new THREE.Mesh(wheelGeo,wheelMat);m.rotation.z=Math.PI/2;
  scene.add(m);return m;
});

// 4) 간단 트랙(커브 + 언덕) ----------------------------
function addHeightfieldTrack(){
  const w=120, l=600, segW=16, segL=120;
  const matrix=[];
  for(let xi=0;xi<segW;xi++){
    const row=[];
    for(let zi=0;zi<segL;zi++){
      // 기본 평면 + 사인 언덕
      const z = zi/(segL-1);
      const x = xi/(segW-1);
      const height = Math.sin(z*Math.PI*4)*1.2 + Math.cos(x* Math.PI*2)*0.4;
      row.push(height);
    }
    matrix.push(row);
  }
  const hfShape=new CANNON.Heightfield(matrix,{elementSize:l/(segL-1)});
  const hfBody=new CANNON.Body({mass:0});
  hfBody.addShape(hfShape,new CANNON.Vec3(-w/2,0,-l/2));
  world.addBody(hfBody);

  // THREE 시각화
  const g=new THREE.PlaneGeometry(w,l,segW-1,segL-1);
  g.vertices?.forEach((v,i)=>{const xi=i%segW, zi=Math.floor(i/segW);v.y=matrix[xi][zi];});
  g.rotateX(-Math.PI/2);
  const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:0x2e2e2e,wireframe:false}));
  scene.add(m);
}
addHeightfieldTrack();

// 5) 더미 AI 차량(경로 따라 전진) ---------------------
const aiMesh = createRoundedCarMesh(3.2,1.2,6.2,0.35,8);
aiMesh.children.forEach(c=>c.material=new THREE.MeshStandardMaterial({color:0x0088ff,metalness:.4,roughness:.4}));
scene.add(aiMesh);
const aiBody=new CANNON.Body({mass:0});
aiBody.addShape(new CANNON.Box(new CANNON.Vec3(1.6,0.6,3.1)));
aiBody.position.set(0,2,-100);
world.addBody(aiBody);
let aiSpeed=18; // km/h
function updateAI(dt){
  aiBody.position.z+=aiSpeed*0.2778*dt; // km/h→m/s
  aiMesh.position.copy(aiBody.position);
  aiMesh.quaternion.copy(aiBody.quaternion);
}
    /* ───────────────────────────────────────────────
   [파트 3] – 입력·기어·사운드·루프
─────────────────────────────────────────────── */

// 입력 상태
const input={left:false,right:false,accel:false,brake:false};
btnLeft .onpointerdown=()=>input.left=true;  btnLeft .onpointerup=()=>input.left=false;
btnRight.onpointerdown=()=>input.right=true; btnRight.onpointerup=()=>input.right=false;
btnAccel.onpointerdown=()=>input.accel=true; btnAccel.onpointerup=()=>input.accel=false;
btnBrake.onpointerdown=()=>input.brake=true; btnBrake.onpointerup=()=>input.brake=false;

// 기어 순환
const gears=['P','R','N','D'];let gearIdx=0;let gear='P';
btnGear.onclick=()=>{gearIdx=(gearIdx+1)%gears.length;gear=gears[gearIdx];gearDisplay.textContent=`기어: ${gear}`;};

// 사운드 (간단 Audio 요소)
const engineAudio=new Audio('https://cdn.jsdelivr.net/gh/napkyn/media-resources@main/engine_loop.mp3');
engineAudio.loop=true;engineAudio.volume=.2;engineAudio.play().catch(()=>{});
const skidAudio  =new Audio('https://cdn.jsdelivr.net/gh/napkyn/media-resources@main/skid_loop.mp3');
skidAudio.loop=true;skidAudio.volume=0; skidAudio.play().catch(()=>{});

// 주행 파라미터
let steer=0, maxSteer=Math.PI/6;
const fwd=3500, rev=1800, maxBrake=1200;

// 메인 루프
let lastT=performance.now();
function animate(){
  requestAnimationFrame(animate);
  const now=performance.now(), dt=(now-lastT)/1000; lastT=now;

  /* 조향 */
  if(input.left)  steer=Math.min(steer+.05,maxSteer);
  else if(input.right) steer=Math.max(steer-.05,-maxSteer);
  else steer*=.9;
  vehicle.setSteeringValue(steer,0);vehicle.setSteeringValue(steer,1);

  /* 기어별 힘 */
  let eng=0, brk=input.brake?maxBrake:0;
  if(gear==='D') eng=input.accel?fwd:0;
  if(gear==='R') eng=input.accel?-rev:0;
  if(gear==='N') eng=0;
  if(gear==='P'){eng=0;brk=3e5;}

  vehicle.applyEngineForce(eng,2);vehicle.applyEngineForce(eng,3);
  [0,1,2,3].forEach(i=>vehicle.setBrake(brk,i));

  /* 물리 step */
  world.step(1/60,dt,8);

  /* THREE 위치 동기화 */
  carMesh.position.copy(chassisBody.position);
  carMesh.quaternion.copy(chassisBody.quaternion);
  vehicle.wheelInfos.forEach((w,i)=>{vehicle.updateWheelTransform(i);
    wheelMeshes[i].position.copy(w.worldTransform.position);
    wheelMeshes[i].quaternion.copy(w.worldTransform.quaternion);
  });

  updateAI(dt);

  /* 카메라 추적 */
  const camOff=new THREE.Vector3(0,4,10).applyQuaternion(carMesh.quaternion);
  camera.position.lerp(carMesh.position.clone().add(camOff),.1);
  camera.lookAt(carMesh.position);

  /* HUD & 사운드 */
  const speed=chassisBody.velocity.length()*3.6;
  hud.textContent=`속도: ${speed.toFixed(0)} km/h`;
  // 엔진 사운드 RPM → playbackRate
  engineAudio.playbackRate=1+Math.min(speed/120,1);
  // 스kid 사운드 (브레이크+속도)
  skidAudio.volume= input.brake && speed>10 ? .4 : 0;

  renderer.render(scene,camera);
}
animate();
  </script>
</body>
</html>
