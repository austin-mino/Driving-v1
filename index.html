<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D 자동차 게임</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: #111;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
    }
    #rotateWarning {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      padding: 20px 30px;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      display: none;
      z-index: 1000;
    }
    #hud {
      position: fixed; top: 20px; left: 20px;
      background: rgba(0,0,0,0.6); padding: 10px 16px;
      border-radius: 10px; font-size: 16px; font-weight: bold;
      z-index: 10;
    }
    #gear {
      position: fixed; top: 20px; right: 20px;
      background: rgba(0,0,0,0.6); padding: 10px 16px;
      border-radius: 10px; font-size: 16px; font-weight: bold;
      z-index: 10;
    }
    .controls {
      position: fixed; bottom: 20px;
      display: flex; gap: 12px; z-index: 10;
    }
    #leftControls { left: 20px; }
    #rightControls { right: 20px; flex-direction: column; }
    button {
      background: #0078d7;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    button:active {
      background: #005a9e;
    }
  </style>
</head>
<body>
<div id="rotateWarning">가로 모드로 전환해주세요</div>
<div id="hud">속도: 0 km/h</div>
<div id="gear">기어: P</div>

<div id="leftControls" class="controls">
  <button id="leftBtn">◀ 좌</button>
  <button id="rightBtn">우 ▶</button>
</div>

<div id="rightControls" class="controls">
  <button id="accelBtn">엑셀</button>
  <button id="brakeBtn">브레이크</button>
  <button id="gearBtn">기어 변경</button>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222222);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 4, -10);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82, 0) });
world.broadphase = new CANNON.SAPBroadphase(world);
world.solver.iterations = 20;

const groundMat = new CANNON.Material();
const groundBody = new CANNON.Body({
  mass: 0,
  shape: new CANNON.Plane(),
  material: groundMat
});
groundBody.quaternion.setFromEuler(-Math.PI/2, 0, 0);
world.addBody(groundBody);

const groundMesh = new THREE.Mesh(
  new THREE.PlaneGeometry(500, 500),
  new THREE.MeshStandardMaterial({ color: 0x333333 })
);
groundMesh.rotation.x = -Math.PI / 2;
scene.add(groundMesh);

const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10, 20, 10);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff, 0.4));

// 자동차 본체
const chassisShape = new CANNON.Box(new CANNON.Vec3(1.5, 0.5, 3));
const chassisBody = new CANNON.Body({ mass: 150 });
chassisBody.addShape(chassisShape);
chassisBody.position.set(0, 2, 0);
world.addBody(chassisBody);

const chassisMesh = new THREE.Mesh(
  new THREE.BoxGeometry(3, 1, 6),
  new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.6, roughness: 0.4 })
);
scene.add(chassisMesh);

// 차량 생성
const vehicle = new CANNON.RaycastVehicle({
  chassisBody,
  indexRightAxis: 0,
  indexUpAxis: 1,
  indexForwardAxis: 2,
});

const wheelOptions = {
  radius: 0.5,
  directionLocal: new CANNON.Vec3(0, -1, 0),
  suspensionStiffness: 30,
  suspensionRestLength: 0.3,
  frictionSlip: 5,
  dampingRelaxation: 2.3,
  dampingCompression: 4.4,
  maxSuspensionForce: 100000,
  rollInfluence: 0.01,
  axleLocal: new CANNON.Vec3(-1, 0, 0),
  maxSuspensionTravel: 0.3,
  useCustomSlidingRotationalSpeed: true,
  customSlidingRotationalSpeed: -30
};

vehicle.addWheel({ ...wheelOptions, chassisConnectionPointLocal: new CANNON.Vec3(-1.2, 0, 2.5), isFrontWheel: true });
vehicle.addWheel({ ...wheelOptions, chassisConnectionPointLocal: new CANNON.Vec3(1.2, 0, 2.5), isFrontWheel: true });
vehicle.addWheel({ ...wheelOptions, chassisConnectionPointLocal: new CANNON.Vec3(-1.2, 0, -2.5), isFrontWheel: false });
vehicle.addWheel({ ...wheelOptions, chassisConnectionPointLocal: new CANNON.Vec3(1.2, 0, -2.5), isFrontWheel: false });

vehicle.addToWorld(world);

// 휠 시각화
const wheelMeshes = [];
vehicle.wheelInfos.forEach(wheel => {
  const mesh = new THREE.Mesh(
    new THREE.CylinderGeometry(wheel.radius, wheel.radius, 0.4, 24),
    new THREE.MeshStandardMaterial({ color: 0x111111 })
  );
  mesh.rotation.z = Math.PI / 2;
  scene.add(mesh);
  wheelMeshes.push(mesh);
});

// UI 연동
const hud = document.getElementById("hud");
const gearDisplay = document.getElementById("gear");
const rotateWarning = document.getElementById("rotateWarning");

function checkOrientation() {
  rotateWarning.style.display = (window.innerHeight > window.innerWidth) ? 'block' : 'none';
}
window.addEventListener('resize', checkOrientation);
checkOrientation();

let gear = 'P';
let gearIndex = 0;
const gearList = ['P', 'R', 'N', 'D'];

document.getElementById("gearBtn").addEventListener("click", () => {
  gearIndex = (gearIndex + 1) % gearList.length;
  gear = gearList[gearIndex];
  gearDisplay.textContent = `기어: ${gear}`;
});

// 입력 처리
const input = { left: false, right: false, accel: false, brake: false };

function bindBtn(id, prop) {
  const btn = document.getElementById(id);
  btn.addEventListener("mousedown", () => input[prop] = true);
  btn.addEventListener("mouseup", () => input[prop] = false);
  btn.addEventListener("touchstart", e => { e.preventDefault(); input[prop] = true; });
  btn.addEventListener("touchend", () => input[prop] = false);
}
bindBtn("leftBtn", "left");
bindBtn("rightBtn", "right");
bindBtn("accelBtn", "accel");
bindBtn("brakeBtn", "brake");

let steering = 0;
const maxSteer = Math.PI / 8;
let engineForce = 0;
const maxEngineForce = 3000;
const maxBrakeForce = 500;

const clock = new THREE.Clock();

function animate() {
  requestAnimationFrame(animate);
  const dt = clock.getDelta();

  if (input.left) steering = Math.max(steering - dt * 2, -maxSteer);
  else if (input.right) steering = Math.min(steering + dt * 2, maxSteer);
  else steering *= 0.9;

  vehicle.setSteeringValue(steering, 0);
  vehicle.setSteeringValue(steering, 1);

  if (gear === 'D') {
    engineForce = input.accel ? maxEngineForce : 0;
  } else if (gear === 'R') {
    engineForce = input.accel ? -maxEngineForce / 2 : 0;
  } else {
    engineForce = 0;
  }

  const brake = input.brake ? maxBrakeForce : 0;

  for (let i = 0; i < 4; i++) {
    vehicle.applyEngineForce(engineForce, i);
    vehicle.setBrake(brake, i);
  }

  world.step(1 / 60, dt);

  chassisMesh.position.copy(chassisBody.position);
  chassisMesh.quaternion.copy(chassisBody.quaternion);

  vehicle.wheelInfos.forEach((wheel, i) => {
    vehicle.updateWheelTransform(i);
    wheelMeshes[i].position.copy(wheel.worldTransform.position);
    wheelMeshes[i].quaternion.copy(wheel.worldTransform.quaternion);
  });

  // 카메라 따라가기
  const camOffset = new THREE.Vector3(0, 4, -10).applyQuaternion(chassisMesh.quaternion);
  const targetPos = chassisMesh.position.clone().add(camOffset);
  camera.position.lerp(targetPos, 0.1);
  camera.lookAt(chassisMesh.position);

  const speed = chassisBody.velocity.length() * 3.6;
  hud.textContent = `속도: ${speed.toFixed(1)} km/h`;

  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
