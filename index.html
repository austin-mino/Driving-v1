<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D 자동차 게임 – 둥근 차체</title>
  <style>
    body{margin:0;overflow:hidden;background:#121212;color:#fff;
         font-family:'Segoe UI',Tahoma,Arial,sans-serif;user-select:none}
    #rotateWarning{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,.85);padding:25px 40px;border-radius:15px;
      font-size:1.3rem;font-weight:bold;z-index:1000;display:none}
    #hud,#gearDisplay,#timerDisplay{position:fixed;background:rgba(0,0,0,.7);
      padding:12px 18px;border-radius:10px;font-weight:700;font-size:18px;z-index:100}
    #hud{top:20px;left:20px}#gearDisplay{top:20px;right:20px}#timerDisplay{top:60px;left:20px}
    #gearControls{position:fixed;top:100px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:100}
    #controlsLeft,#driveControls{position:fixed;bottom:20px;display:flex;gap:15px;z-index:100}
    #controlsLeft{left:20px}#driveControls{right:20px}
    button.controlBtn{padding:14px 20px;border-radius:12px;border:none;background:#0078d7;
      color:#fff;font-weight:700;font-size:16px;cursor:pointer;touch-action:manipulation;transition:.2s}
    button.controlBtn:active{background:#005a9e}
    @media(max-width:600px){button.controlBtn{padding:18px 22px;font-size:20px}}
  </style>
</head>
<body>
<div id="rotateWarning">가로 모드로 전환해주세요</div>
<div id="hud">속도: 0 km/h</div>
<div id="timerDisplay">타이머: 0.00 s</div>
<div id="gearDisplay">기어: P</div>

<!-- UI 버튼 -->
<div id="controlsLeft">
  <button id="btnLeft"  class="controlBtn">◀ 좌</button>
  <button id="btnRight" class="controlBtn">우 ▶</button>
</div>
<div id="driveControls">
  <button id="btnAccel" class="controlBtn">엑셀</button>
  <button id="btnBrake" class="controlBtn">브레이크</button>
</div>
<div id="gearControls">
  <button class="controlBtn">P</button>
  <button class="controlBtn">R</button>
  <button class="controlBtn">N</button>
  <button class="controlBtn">D</button>
</div>

<script type="module">
import * as THREE  from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

/* ── 디스플레이 방향 체크 ─────────────────── */
const rotateWarning=document.getElementById('rotateWarning');
function checkOrientation(){rotateWarning.style.display=
  innerHeight>innerWidth?'block':'none'}
addEventListener('resize',checkOrientation);addEventListener('orientationchange',checkOrientation);
checkOrientation();

/* ── Three.js Scene ───────────────────────── */
const scene=new THREE.Scene();scene.background=new THREE.Color(0x222222);
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.1,5000);
camera.position.set(0,5,15);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);document.body.appendChild(renderer.domElement);
addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight)});

/* ── Cannon World ─────────────────────────── */
const world=new CANNON.World({gravity:new CANNON.Vec3(0,-9.82,0)});
world.broadphase=new CANNON.SAPBroadphase(world);
world.defaultContactMaterial.friction=.6;

/* 지면 */
const groundBody=new CANNON.Body({mass:0});groundBody.addShape(new CANNON.Plane());
groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);world.addBody(groundBody);
const groundMesh=new THREE.Mesh(new THREE.PlaneGeometry(2000,2000),
  new THREE.MeshStandardMaterial({color:0x444444}));
groundMesh.rotation.x=-Math.PI/2;scene.add(groundMesh);

/* 트랙 울타리 */
function addBarrier(x,y,z,rot){
  const s=2,shape=new CANNON.Box(new CANNON.Vec3(s/2,s/2,.5));
  const body=new CANNON.Body({mass:0,shape});body.position.set(x,y+s/2,z);
  body.quaternion.setFromEuler(0,rot,0);world.addBody(body);
  const mesh=new THREE.Mesh(new THREE.BoxGeometry(s,s,1),
    new THREE.MeshStandardMaterial({color:0x884400}));
  mesh.position.copy(body.position);mesh.quaternion.copy(body.quaternion);scene.add(mesh);}
const R=80,N=72;for(let i=0;i<N;i++){
  const a=i*2*Math.PI/N,h=Math.sin(i*.5)*2;
  addBarrier(Math.cos(a)*(R-1),h,Math.sin(a)*(R-1),a);
  addBarrier(Math.cos(a)*(R+1),h,Math.sin(a)*(R+1),a);}

/* ── 자동차 차체 ───────────────────────────── */
const chassisShape=new CANNON.Box(new CANNON.Vec3(1.5,.5,3));
const chassisBody=new CANNON.Body({mass:110,angularDamping:.5});
chassisBody.addShape(chassisShape);chassisBody.position.set(0,2,0);world.addBody(chassisBody);

function createCarMesh(){
  const g=new THREE.Group();
  const red=new THREE.MeshStandardMaterial({color:0xff4444,metalness:.6,roughness:.4});
  g.add(new THREE.Mesh(new THREE.BoxGeometry(3,1.2,6),red).position.set(0,.6,0));
  const roof=new THREE.Mesh(new THREE.BoxGeometry(2.5,.4,3),
    new THREE.MeshStandardMaterial({color:0xaa2222}));
  roof.position.set(0,1.3,0);g.add(roof);
  return g;}
const carMesh=createCarMesh();scene.add(carMesh);

/* ── RaycastVehicle & 휠 ──────────────────── */
const vehicle=new CANNON.RaycastVehicle({chassisBody,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2});
const wheelOpt={radius:.55,directionLocal:new CANNON.Vec3(0,-1,0),suspensionStiffness:45,
  suspensionRestLength:.7,frictionSlip:5,axleLocal:new CANNON.Vec3(1,0,0),
  rollInfluence:.02,useCustomSlidingRotationalSpeed:true,customSlidingRotationalSpeed:-30};
[[-1.2,.2, 2.4,true],[1.2,.2, 2.4,true],[-1.2,.2,-2.4,false],[1.2,.2,-2.4,false]]
  .forEach(p=>vehicle.addWheel({...wheelOpt,chassisConnectionPointLocal:new CANNON.Vec3(...p)}));
vehicle.addToWorld(world);

/* 휠 메쉬 */
const wheelHolders=[];
vehicle.wheelInfos.forEach(w=>{
  const h=new THREE.Group();scene.add(h);wheelHolders.push(h);
  const tire=new THREE.Mesh(new THREE.CylinderGeometry(w.radius,w.radius,.4,24),
    new THREE.MeshStandardMaterial({color:0x222222,metalness:.7,roughness:.4}));
  tire.rotation.z=Math.PI/2;h.add(tire);});

/* ── 라이트 ──────────────────────────────── */
scene.add(new THREE.AmbientLight(0xffffff,1));
const dir=new THREE.DirectionalLight(0xffffff,1.2);dir.position.set(10,20,10);scene.add(dir);

/* ── 입력 & UI ───────────────────────────── */
const qs=id=>document.getElementById(id);
const input={left:false,right:false,accel:false,brake:false};
[['btnLeft','left'],['btnRight','right'],['btnAccel','accel'],['btnBrake','brake']].forEach(([id,k])=>{
  const b=qs(id);['pointerdown','touchstart'].forEach(e=>b.addEventListener(e,ev=>{
    ev.preventDefault();input[k]=true;}));
  ['pointerup','touchend','touchcancel'].forEach(e=>b.addEventListener(e,()=>input[k]=false));});
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(['arrowleft','a'].includes(k))input.left=true;
  if(['arrowright','d'].includes(k))input.right=true;
  if(['arrowup','w'].includes(k))input.accel=true;
  if(['arrowdown','s'].includes(k))input.brake=true;
  if('1234'.includes(k))setGear({1:'P',2:'R',3:'N',4:'D'}[k]);});
addEventListener('keyup',e=>{
  const k=e.key.toLowerCase();
  if(['arrowleft','a'].includes(k))input.left=false;
  if(['arrowright','d'].includes(k))input.right=false;
  if(['arrowup','w'].includes(k))input.accel=false;
  if(['arrowdown','s'].includes(k))input.brake=false;});

const gearBtns=[...document.querySelectorAll('#gearControls button')];
let gear='P';
function updateGearDisplay(){
  qs('gearDisplay').textContent=`기어: ${gear}`;
  const col={P:'#0ff',R:'#f55',N:'#ff5',D:'#5f5'};
  gearBtns.forEach(b=>{
    if(b.textContent===gear){b.style.background=col[gear];b.style.color='#000'}
    else{b.style.background='#0078d7';b.style.color='#fff'}});
}
function setGear(g){gear=g;updateGearDisplay();}updateGearDisplay();
gearBtns.forEach(b=>b.onclick=()=>setGear(b.textContent));

/* ── 차량 제어 파라미터 ──────────────────── */
const maxEngine=1200,maxBrake=300,maxSteer=Math.PI/8;
let steering=0,engine=0;

/* 카메라 */
function updateCamera(){
  const f=new THREE.Vector3(0,0,1).applyQuaternion(carMesh.quaternion).normalize();
  const target=carMesh.position.clone().add(new THREE.Vector3(0,1.5,0));
  const camPos=target.clone().addScaledVector(f,-8);camPos.y+=4;
  camera.position.lerp(camPos,.1);camera.lookAt(target);
}

/* HUD & 타이머 */
let startTime=null,elapsed=0;
const hud=qs('hud'),timerDisp=qs('timerDisplay');

/* 애니메이션 루프 */
let last;
function animate(t){
  requestAnimationFrame(animate);
  if(!last)last=t;const dt=(t-last)/1000;last=t;

  /* 입력 → 조향값 */
  if(input.left) steering=Math.min(steering+0.05,maxSteer);
  else if(input.right) steering=Math.max(steering-0.05,-maxSteer);
  else steering*=0.8; // 서서히 복귀
  vehicle.setSteeringValue(steering,0);vehicle.setSteeringValue(steering,1);

  /* 입력 → 엔진/브레이크 */
  engine=0;applyBrake(0);
  if(gear==='D'){if(input.accel)engine=maxEngine;if(input.brake)applyBrake(maxBrake);}
  else if(gear==='R'){if(input.accel)engine=-maxEngine;if(input.brake)applyBrake(maxBrake);}
  else if(gear==='N'){if(input.brake)applyBrake(maxBrake);}
  else if(gear==='P'){applyBrake(maxBrake*5);}

  vehicle.applyEngineForce(engine,2);vehicle.applyEngineForce(engine,3);

  /* 물리 스텝 */
  world.step(1/60,dt,3);

  /* 메쉬 동기화 */
  carMesh.position.copy(chassisBody.position);carMesh.quaternion.copy(chassisBody.quaternion);
  wheelHolders.forEach((h,i)=>{
    vehicle.updateWheelTransform(i);const t=vehicle.wheelInfos[i].worldTransform;
    h.position.copy(t.position);h.quaternion.copy(t.quaternion);});

  /* HUD/타이머 */
  const speed=(chassisBody.velocity.length()*3.6).toFixed(1);
  hud.textContent=`속도: ${speed} km/h`;
  if(engine!==0){if(startTime===null)startTime=t;elapsed=(t-startTime)/1000;}
  else{startTime=null;}
  timerDisp.textContent=`타이머: ${elapsed.toFixed(2)} s`;

  updateCamera();
  renderer.render(scene,camera);
}
function applyBrake(f){for(let i=0;i<4;i++)vehicle.setBrake(f,i);}

animate();
</script>
</body>
</html>
