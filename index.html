<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cannon-es 물리엔진 + 기어 레버 (카메라/엔진 수정)</title>
<style>
  body{margin:0;overflow:hidden;background:#000;font-family:sans-serif;color:#fff}
  #rotateWarning{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    padding:20px;border-radius:10px;background:rgba(0,0,0,.8);display:none;z-index:99}
  #buttons{position:fixed;bottom:20px;left:20px;display:flex;gap:10px;pointer-events:none;z-index:10}
  button{padding:14px 18px;border:none;border-radius:10px;background:#4f9eff;color:#fff;font-weight:700;font-size:16px;pointer-events:auto}
  #leverBox{position:fixed;right:20px;bottom:20px;width:60px;height:220px;background:#222;border-radius:12px;
    padding:8px;display:flex;flex-direction:column;justify-content:space-between;gap:6px;z-index:10}
  .gearSlot{flex:1;background:#333;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
  #leverKnob{position:absolute;left:calc(50% - 12px);width:24px;height:24px;border-radius:50%;background:#ff9b00;transition:top .15s}
  #hud{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);text-align:center;
    background:rgba(0,0,0,.6);padding:10px 20px;border-radius:10px;font-weight:700}
</style>
</head>
<body>
<div id="rotateWarning">가로 모드로 전환해주세요</div>

<!-- HUD -->
<div id="hud">
  <div id="gearText">기어: P</div>
  <div id="speedText">속도: 0 km/h</div>
</div>

<!-- 조작 버튼 -->
<div id="buttons">
  <button id="leftBtn">◀ 좌</button><button id="rightBtn">우 ▶</button>
  <button id="accelBtn">엑셀</button><button id="brakeBtn">브레이크</button>
</div>

<!-- 기어 레버 -->
<div id="leverBox">
  <div class="gearSlot" data-gear="P">P</div>
  <div class="gearSlot" data-gear="R">R</div>
  <div class="gearSlot" data-gear="N">N</div>
  <div class="gearSlot" data-gear="D">D</div>
  <div id="leverKnob"></div>
</div>

<script type="module">
import * as THREE  from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";
import * as CANNON from "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js";

/* ── 회전경고 ─────────────────────── */
const rotateWarn=document.getElementById("rotateWarning");
function checkOri(){rotateWarn.style.display=(innerHeight>innerWidth)?"block":"none";}
addEventListener("resize",checkOri);addEventListener("orientationchange",checkOri);checkOri();

/* ── THREE 씬 ─────────────────────── */
const scene=new THREE.Scene();scene.background=new THREE.Color(0x000000);
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);camera.position.set(0,5,-12);
const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(innerWidth,innerHeight);document.body.appendChild(renderer.domElement);
addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.6));
const dl=new THREE.DirectionalLight(0xffffff,0.9);dl.position.set(5,10,-5);scene.add(dl);

/* ── Cannon 월드 ─────────────────── */
const world=new CANNON.World({gravity:new CANNON.Vec3(0,-9.82,0)});
world.broadphase=new CANNON.SAPBroadphase(world);
world.defaultContactMaterial.friction=0.6;

/* 지면 */
const groundBody=new CANNON.Body({mass:0,shape:new CANNON.Plane()});
groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);world.addBody(groundBody);
const groundMesh=new THREE.Mesh(new THREE.PlaneGeometry(500,500),new THREE.MeshStandardMaterial({color:0x333333}));
groundMesh.rotation.x=-Math.PI/2;scene.add(groundMesh);

/* ── 차량 ─────────────────────────── */
const chassisShape=new CANNON.Box(new CANNON.Vec3(1.5,0.4,3));
const chassisBody=new CANNON.Body({mass:150});chassisBody.addShape(chassisShape);chassisBody.position.set(0,1,0);
const vehicle=new CANNON.RaycastVehicle({chassisBody,indexUpAxis:1,indexRightAxis:0,indexForwardAxis:2});
const wheelOpt={radius:0.6,directionLocal:new CANNON.Vec3(0,-1,0),axleLocal:new CANNON.Vec3(-1,0,0),
  suspensionStiffness:30,suspensionRestLength:0.3,frictionSlip:4,rollInfluence:0.01};
vehicle.addWheel({...wheelOpt,chassisConnectionPointLocal:new CANNON.Vec3(-1.2,0, 2.4),isFrontWheel:true});
vehicle.addWheel({...wheelOpt,chassisConnectionPointLocal:new CANNON.Vec3( 1.2,0, 2.4),isFrontWheel:true});
vehicle.addWheel({...wheelOpt,chassisConnectionPointLocal:new CANNON.Vec3(-1.2,0,-2.4),isFrontWheel:false});
vehicle.addWheel({...wheelOpt,chassisConnectionPointLocal:new CANNON.Vec3( 1.2,0,-2.4),isFrontWheel:false});
vehicle.addToWorld(world);

/* THREE 메시는 별도 */
const carMesh=new THREE.Mesh(new THREE.BoxGeometry(3,0.8,6),new THREE.MeshStandardMaterial({color:0xff3333}));
scene.add(carMesh);
const wheelMeshes=[];vehicle.wheelInfos.forEach(w=>{
  const m=new THREE.Mesh(new THREE.CylinderGeometry(w.radius,w.radius,0.4,24),
    new THREE.MeshStandardMaterial({color:0x222222}));
  m.rotation.z=Math.PI/2;scene.add(m);wheelMeshes.push(m);
});

/* ── UI / 입력 ───────────────────── */
const state={left:0,right:0,accel:0,brake:0};
function bind(id,key){const b=document.getElementById(id);
  b.onpointerdown=()=>state[key]=1;b.onpointerup=b.onpointerleave=()=>state[key]=0;
  b.ontouchstart=e=>{e.preventDefault();state[key]=1;};b.ontouchend=()=>state[key]=0;}
bind("leftBtn","left");bind("rightBtn","right");bind("accelBtn","accel");bind("brakeBtn","brake");

let gear="P";const gearTxt=document.getElementById("gearText"),spdTxt=document.getElementById("speedText");
const knob=document.getElementById("leverKnob"),slots=[...document.querySelectorAll(".gearSlot")];
function moveKnob(){const s=slots.find(v=>v.dataset.gear===gear);const r=s.getBoundingClientRect(),p=s.parentElement.getBoundingClientRect();
  knob.style.top=`${r.top-p.top+r.height/2-12}px`;gearTxt.textContent=`기어: ${gear}`;}
slots.forEach(s=>{s.onclick=s.ontouchstart=e=>{e&&e.preventDefault();shift(s.dataset.gear);};});
function shift(g){
  if(g===gear)return;
  const spd=chassisBody.velocity.length();
  if((g==="R"&&spd>1)||(g==="P"&&spd>0.1)||(g==="D"&&gear==="R"&&spd>1)||(g==="R"&&gear==="D"&&spd>1))return;
  gear=g;moveKnob();
}

/* ── 파라미터 ───────────────────── */
const maxSteer=Math.PI/6;const maxFwd=4000;const maxRev=1500;

/* ── 루프 ───────────────────────── */
let last=performance.now();
(function loop(){
  requestAnimationFrame(loop);
  const now=performance.now(),dt=(now-last)/1000;last=now;

  /* 조향 */
  let steerVal=0;if(state.left)steerVal+=0.035;if(state.right)steerVal-=0.035;steerVal=THREE.MathUtils.clamp(steerVal,maxSteer,-maxSteer)*0.9;
  vehicle.setSteeringValue(steerVal,0);vehicle.setSteeringValue(steerVal,1);

  /* 엔진·브레이크 (부호 주의) */
  let eng=0,brk=0;
  if(gear==="D"){ if(state.accel)eng=-maxFwd; if(state.brake)brk=2000; }
  else if(gear==="R"){ if(state.accel)eng= maxRev; if(state.brake)brk=2000; }
  else if(gear==="N"){ if(state.brake)brk=2000; }
  else if(gear==="P"){ brk=5e5; }

  [2,3].forEach(i=>vehicle.applyEngineForce(eng,i));
  [0,1,2,3].forEach(i=>vehicle.setBrake(brk,i));

  /* 물리 업데이트 */
  world.step(1/60,dt,8);

  /* THREE 동기화 */
  carMesh.position.copy(chassisBody.position);
  carMesh.quaternion.copy(chassisBody.quaternion);
  wheelMeshes.forEach((m,i)=>{vehicle.updateWheelTransform(i);
    const t=vehicle.wheelInfos[i].worldTransform;m.position.copy(t.position);m.quaternion.copy(t.quaternion);});

  /* 카메라 – 스프링암 방식 */
  const camLocalOffset=new THREE.Vector3(0,4,-10);          // 차량 좌표계에서 뒤·위 오프셋
  const desired=camLocalOffset.clone().applyQuaternion(carMesh.quaternion).add(carMesh.position);
  camera.position.lerp(desired,0.06);                       // 부드럽게 수렴
  const lookTarget=carMesh.position.clone().add(new THREE.Vector3(0,1.5,0));
  camera.lookAt(lookTarget);

  /* HUD */
  spdTxt.textContent=`속도: ${Math.round(chassisBody.velocity.length()*3.6)} km/h`;

  renderer.render(scene,camera);
})();
</script>
</body>
</html>
