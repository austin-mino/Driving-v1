<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D Car – Three.js + Cannon-es</title>
<style>
  :root{--blue:#4f9eff}
  body{margin:0;overflow:hidden;background:#000;color:#fff;font-family:sans-serif}
  /* HUD */
  #hud{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
       background:rgba(0,0,0,.6);padding:10px 22px;border-radius:10px;font-weight:700;z-index:10}
  /* 버튼 */
  #buttons{position:fixed;bottom:20px;left:20px;display:flex;gap:10px;pointer-events:none;z-index:10}
  button{padding:14px 18px;border:0;border-radius:10px;background:var(--blue);color:#fff;font:700 16px sans-serif;pointer-events:auto}
  /* 기어 레버 */
  #leverBox{position:fixed;right:20px;bottom:20px;width:60px;height:220px;background:#222;border-radius:12px;
            padding:8px;display:flex;flex-direction:column;justify-content:space-between;gap:6px;z-index:10}
  .gearSlot{flex:1;background:#333;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;user-select:none}
  #leverKnob{position:absolute;left:calc(50% - 12px);width:24px;height:24px;border-radius:50%;background:#ff9b00;transition:top .15s ease;pointer-events:none}
  /* 세로 모드와 버튼 재배치 */
  @media(orientation:portrait){
    #buttons{flex-direction:column;bottom:80px;left:50%;transform:translateX(-50%)}
    #leverBox{right:50%;transform:translateX(80px);bottom:80px}
    #hud{bottom:20px}
  }
</style>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <div id="gearTxt">기어: P</div>
  <div id="spdTxt">속도: 0 km/h</div>
</div>

<!-- 입력 버튼 -->
<div id="buttons">
  <button id="leftBtn">◀ 좌</button>
  <button id="rightBtn">우 ▶</button>
  <button id="accelBtn">엑셀</button>
  <button id="brakeBtn">브레이크</button>
</div>

<!-- 기어 레버 -->
<div id="leverBox">
  <div class="gearSlot" data-gear="P">P</div>
  <div class="gearSlot" data-gear="R">R</div>
  <div class="gearSlot" data-gear="N">N</div>
  <div class="gearSlot" data-gear="D">D</div>
  <div id="leverKnob"></div>
</div>

<script type="module">
import * as THREE  from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js';

/*────────────────────────── 1. THREE 기본 ──────────────────────────*/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,5,-12);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);
addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,.7));
const dl=new THREE.DirectionalLight(0xffffff,.9);dl.position.set(5,10,-5);scene.add(dl);

/*────────────────────────── 2. Cannon 월드 ─────────────────────────*/
const world=new CANNON.World({gravity:new CANNON.Vec3(0,-9.82,0)});
world.broadphase=new CANNON.SAPBroadphase(world);
world.defaultContactMaterial.friction=.6;

/* 지면 */
const groundBody=new CANNON.Body({mass:0,shape:new CANNON.Plane()});
groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);
world.addBody(groundBody);
scene.add(new THREE.Mesh(new THREE.PlaneGeometry(600,600),new THREE.MeshStandardMaterial({color:0x333333}))).rotation.x=-Math.PI/2;

/*────────────────────────── 3. 자동차 ───────────────────────────────*/
const chassisShape=new CANNON.Box(new CANNON.Vec3(1.5,0.4,3));
const chassisBody=new CANNON.Body({mass:150});
chassisBody.addShape(chassisShape);
chassisBody.position.set(0,1,0);

const vehicle=new CANNON.RaycastVehicle({
  chassisBody,
  indexUpAxis:1,indexRightAxis:0,indexForwardAxis:2
});
const wOpt={radius:.6,directionLocal:new CANNON.Vec3(0,-1,0),axleLocal:new CANNON.Vec3(-1,0,0),
            suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:4,rollInfluence:.01};
vehicle.addWheel({...wOpt,chassisConnectionPointLocal:new CANNON.Vec3(-1.2,0, 2.4),isFrontWheel:true});
vehicle.addWheel({...wOpt,chassisConnectionPointLocal:new CANNON.Vec3( 1.2,0, 2.4),isFrontWheel:true});
vehicle.addWheel({...wOpt,chassisConnectionPointLocal:new CANNON.Vec3(-1.2,0,-2.4),isFrontWheel:false});
vehicle.addWheel({...wOpt,chassisConnectionPointLocal:new CANNON.Vec3( 1.2,0,-2.4),isFrontWheel:false});
vehicle.addToWorld(world);

/* THREE 메쉬 */
const carMesh=new THREE.Mesh(new THREE.BoxGeometry(3,0.8,6),new THREE.MeshStandardMaterial({color:0xff3333}));
scene.add(carMesh);
const wheelMeshes=[];
vehicle.wheelInfos.forEach(w=>{
  const m=new THREE.Mesh(new THREE.CylinderGeometry(w.radius,w.radius,.4,24),new THREE.MeshStandardMaterial({color:0x222222}));
  m.rotation.z=Math.PI/2;scene.add(m);wheelMeshes.push(m);
});

/*────────────────────────── 4. UI & 입력 ───────────────────────────*/
const state={left:0,right:0,accel:0,brake:0};
function bind(id,prop){const b=document.getElementById(id);
  b.onpointerdown=()=>state[prop]=1;b.onpointerup=b.onpointerleave=()=>state[prop]=0;
  b.ontouchstart=e=>{e.preventDefault();state[prop]=1;};b.ontouchend=()=>state[prop]=0;}
bind('leftBtn','left');bind('rightBtn','right');bind('accelBtn','accel');bind('brakeBtn','brake');

let gear='P';const gearTxt=document.getElementById('gearTxt'),spdTxt=document.getElementById('spdTxt');
const knob=document.getElementById('leverKnob'),slots=[...document.querySelectorAll('.gearSlot')];
function moveKnob(){const s=slots.find(v=>v.dataset.gear===gear);const r=s.getBoundingClientRect(),p=s.parentElement.getBoundingClientRect();
  knob.style.top=`${r.top-p.top+r.height/2-12}px`;gearTxt.textContent=`기어: ${gear}`;}
slots.forEach(s=>{s.onclick=s.ontouchstart=e=>{e&&e.preventDefault();shift(s.dataset.gear);};});
function shift(g){
  if(g===gear)return;
  const speed=chassisBody.velocity.length();
  if((g==='R'&&speed>1)||(g==='P'&&speed>.2)||(g==='D'&&gear==='R'&&speed>1)||(g==='R'&&gear==='D'&&speed>1))return;
  gear=g;moveKnob();
  // 파킹 브레이크
  for(let i=0;i<4;i++) vehicle.setBrake(g==='P'?5e5:0,i);
}
moveKnob();

/*────────────────────────── 5. 파라미터 ───────────────────────────*/
const maxSteer=Math.PI/6,maxFwd=4200,maxRev=1600;

/*────────────────────────── 6. 루프 ───────────────────────────────*/
let steerVal=0,last=performance.now();
(function loop(){
  requestAnimationFrame(loop);
  const now=performance.now(),dt=(now-last)/1000;last=now;

  // 입력 → 조향
  if(state.left)  steerVal=Math.min(steerVal+0.035,maxSteer);
  else if(state.right) steerVal=Math.max(steerVal-0.035,-maxSteer);
  else steerVal*=0.9;
  vehicle.setSteeringValue(steerVal,0);
  vehicle.setSteeringValue(steerVal,1);

  // 입력 → 엔진 & 브레이크
  let eng=0,brk=0;
  if(gear==='D'){ if(state.accel)eng=-maxFwd; if(state.brake)brk=2000; }
  else if(gear==='R'){ if(state.accel)eng= maxRev; if(state.brake)brk=2000; }
  else if(gear==='N'){ if(state.brake)brk=2000; }
  // P 기어는 위 shift()에서 이미 브레이크 ON
  [2,3].forEach(i=>vehicle.applyEngineForce(eng,i));
  [0,1,2,3].forEach(i=>vehicle.setBrake(vehicle.wheelInfos[i].brake?vehicle.wheelInfos[i].brake:brk,i));

  // 물리 step
  world.step(1/60,dt,8);

  // THREE 동기화
  carMesh.position.copy(chassisBody.position);
  carMesh.quaternion.copy(chassisBody.quaternion);
  wheelMeshes.forEach((m,i)=>{vehicle.updateWheelTransform(i);
    const t=vehicle.wheelInfos[i].worldTransform;m.position.copy(t.position);m.quaternion.copy(t.quaternion);});

  // 카메라: 차 뒤 6m, 높이 2m
  const behind=6,height=2;
  const dir=new THREE.Vector3(0,0,1).applyQuaternion(carMesh.quaternion);
  const desired=carMesh.position.clone().addScaledVector(dir,-behind);desired.y+=height;
  camera.position.lerp(desired,.1);
  camera.lookAt(carMesh.position);

  // HUD
  spdTxt.textContent=`속도: ${Math.round(chassisBody.velocity.length()*3.6)} km/h`;

  renderer.render(scene,camera);
})();
</script>
</body>
</html>
